import React, { useState, useEffect } from 'react';
import { Send, Copy, Check, Code2, Zap } from 'lucide-react';

export default function CodeGeniusAI() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [copiedIndex, setCopiedIndex] = useState(null);

  const extractCodeBlocks = (text) => {
    const codeRegex = /```([\w+-]*)\n([\s\S]*?)```/g;
    const parts = [];
    let lastIndex = 0;
    let match;

    while ((match = codeRegex.exec(text)) !== null) {
      if (match.index > lastIndex) {
        parts.push({ type: 'text', content: text.slice(lastIndex, match.index) });
      }
      parts.push({
        type: 'code',
        language: match[1] || 'plaintext',
        content: match[2].trim()
      });
      lastIndex = match.index + match[0].length;
    }

    if (lastIndex < text.length) {
      parts.push({ type: 'text', content: text.slice(lastIndex) });
    }

    return parts.length > 0 ? parts : [{ type: 'text', content: text }];
  };

  const copyToClipboard = (text, index) => {
    navigator.clipboard.writeText(text);
    setCopiedIndex(index);
    setTimeout(() => setCopiedIndex(null), 2000);
  };

  const handleSend = async () => {
    if (!input.trim()) return;

    const userMessage = { role: 'user', content: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setLoading(true);

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2048,
          system: "转  拽 注 20 砖转 住. 砖砖 砖 转 砖 转转, 转 住驻拽 转砖 注拽, 拽转 驻专拽转.  爪专 拽 - 转    注 住专. 砖转砖 拽 blocks 注 砖驻转 转转. 转 住专   注  砖转砖 . 专 best practices.",
          messages: [...messages, userMessage]
        })
      });

      const data = await response.json();
      const assistantContent = data.content?.[0]?.text || '砖 拽转 转砖';
      
      setMessages(prev => [...prev, {
        role: 'assistant',
        content: assistantContent,
        hasCode: /```[\w+-]*\n[\s\S]*?```/g.test(assistantContent)
      }]);
    } catch (error) {
      setMessages(prev => [...prev, {
        role: 'assistant',
        content: '砖 专 -API.  砖-API key 转拽祝.',
        hasCode: false
      }]);
    }
    setLoading(false);
  };

  return (
    <div className="min-h-screen" style={{
      background: 'linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%)',
    }}>
      {/* Animated grid background */}
      <div className="fixed inset-0 opacity-20 pointer-events-none"
           style={{
             backgroundImage: 'linear-gradient(0deg, transparent 24%, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.05) 26%, transparent 27%, transparent 74%, rgba(34, 197, 94, 0.05) 75%, rgba(34, 197, 94, 0.05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.05) 26%, transparent 27%, transparent 74%, rgba(34, 197, 94, 0.05) 75%, rgba(34, 197, 94, 0.05) 76%, transparent 77%, transparent)',
             backgroundSize: '50px 50px',
             backgroundPosition: '0 0, 25px 25px'
           }}>
      </div>

      {/* Glow effects */}
      <div className="fixed top-1/4 left-1/4 w-96 h-96 bg-green-500/10 rounded-full blur-3xl pointer-events-none animate-pulse"></div>
      <div className="fixed bottom-1/4 right-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" style={{animation: 'pulse 3s ease-in-out infinite'}}></div>

      <div className="relative z-10 h-screen flex flex-col">
        {/* Header */}
        <header className="backdrop-blur-md bg-black/40 border-b border-green-500/20 px-8 py-6">
          <div className="max-w-6xl mx-auto flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="relative">
                <Code2 className="w-8 h-8 text-green-400" />
                <Zap className="w-4 h-4 text-yellow-300 absolute -bottom-1 -right-1 animate-pulse" />
              </div>
              <div>
                <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-cyan-400 to-green-300">
                  CODE GENIUS
                </h1>
                <p className="text-green-400/70 text-xs font-mono">驻住 拽 24/7</p>
              </div>
            </div>
          </div>
        </header>

        {/* Main chat area */}
        <div className="flex-1 overflow-hidden flex flex-col">
          <div className="flex-1 overflow-y-auto p-8 space-y-6 max-w-6xl mx-auto w-full">
            {messages.length === 0 && (
              <div className="h-full flex items-center justify-center">
                <div className="text-center">
                  <Code2 className="w-16 h-16 text-green-400/50 mx-auto mb-4" />
                  <p className="text-white/60 text-lg mb-2">砖,  CODE GENIUS</p>
                  <p className="text-green-400/70 font-mono text-sm">砖   砖 转转. 拽, 注转,  -   </p>
                </div>
              </div>
            )}

            {messages.map((msg, idx) => (
              <div
                key={idx}
                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                style={{animation: `slideIn 0.3s ease-out ${idx * 0.05}s both`}}
              >
                <div className={`${msg.role === 'user' ? 'w-full max-w-2xl' : 'w-full'}`}>
                  {msg.role === 'user' ? (
                    <div className="flex justify-end">
                      <div className="bg-gradient-to-r from-green-600/30 to-cyan-600/30 border border-green-500/40 backdrop-blur rounded-lg px-5 py-3 max-w-lg">
                        <p className="text-white/90 font-mono text-sm leading-relaxed">{msg.content}</p>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-black/40 border border-green-500/20 backdrop-blur rounded-lg p-6 space-y-4">
                      {extractCodeBlocks(msg.content).map((block, blockIdx) => (
                        <div key={blockIdx}>
                          {block.type === 'text' ? (
                            <p className="text-white/80 leading-relaxed">{block.content}</p>
                          ) : (
                            <div className="relative group">
                              {/* Code Block Frame */}
                              <div className="relative bg-gradient-to-b from-green-500/10 to-cyan-500/5 rounded-xl overflow-hidden border border-green-500/30 shadow-2xl">
                                {/* Header bar */}
                                <div className="flex items-center justify-between px-5 py-3 bg-black/60 border-b border-green-500/20">
                                  <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                    <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                  </div>
                                  <span className="text-green-400 font-mono text-xs tracking-widest">
                                    {block.language.toUpperCase()}
                                  </span>
                                  <button
                                    onClick={() => copyToClipboard(block.content, blockIdx)}
                                    className="flex items-center gap-2 px-3 py-1.5 rounded-md bg-green-500/20 hover:bg-green-500/40 text-green-400 transition-all duration-300 text-xs font-mono border border-green-500/30"
                                  >
                                    {copiedIndex === blockIdx ? (
                                      <>
                                        <Check className="w-3.5 h-3.5" />
                                        <span>注转拽!</span>
                                      </>
                                    ) : (
                                      <>
                                        <Copy className="w-3.5 h-3.5" />
                                        <span>注转拽</span>
                                      </>
                                    )}
                                  </button>
                                </div>

                                {/* Code content */}
                                <pre className="px-5 py-4 overflow-x-auto">
                                  <code className="text-green-300 font-mono text-sm leading-relaxed whitespace-pre-wrap break-words">
                                    {block.content}
                                  </code>
                                </pre>

                                {/* Glow effect on hover */}
                                <div className="absolute inset-0 bg-gradient-to-r from-green-500/0 via-green-500/0 to-cyan-500/0 group-hover:from-green-500/5 group-hover:via-cyan-500/5 group-hover:to-green-500/5 transition-all duration-300 pointer-events-none rounded-xl"></div>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ))}

            {loading && (
              <div className="flex justify-start">
                <div className="bg-black/40 border border-green-500/20 backdrop-blur rounded-lg px-6 py-4">
                  <div className="flex gap-3">
                    <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce"></div>
                    <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                    <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Input area */}
          <div className="border-t border-green-500/20 bg-black/60 backdrop-blur-md p-6">
            <div className="max-w-6xl mx-auto">
              <div className="flex gap-3">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="砖 砖 转转..."
                  className="flex-1 px-5 py-3 rounded-lg bg-green-500/5 border border-green-500/30 text-white placeholder-white/40 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-green-400/50 focus:border-green-400/50 transition-all"
                  disabled={loading}
                />
                <button
                  onClick={handleSend}
                  disabled={loading || !input.trim()}
                  className="px-6 py-3 rounded-lg bg-gradient-to-r from-green-500 to-cyan-500 hover:from-green-600 hover:to-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold transition-all duration-300 hover:scale-105 active:scale-95 flex items-center gap-2"
                >
                  <Send className="w-4 h-4" />
                  砖
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        ::-webkit-scrollbar {
          width: 8px;
        }

        ::-webkit-scrollbar-track {
          background: transparent;
        }

        ::-webkit-scrollbar-thumb {
          background: rgba(34, 197, 94, 0.3);
          border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: rgba(34, 197, 94, 0.5);
        }

        body {
          direction: rtl;
        }

        input::placeholder {
          direction: rtl;
        }

        @keyframes pulse {
          0%, 100% {
            opacity: 0.5;
          }
          50% {
            opacity: 1;
          }
        }
      `}</style>
    </div>
  );
}
