const querystring = require('querystring');

const DISCORD_CLIENT_ID = '1474379665606049998';
const DISCORD_CLIENT_SECRET = 'Zwd_fzVj5XoOoTGcYCtZLA48B0Mblyz2';
const DISCORD_REDIRECT_URI = 'https://danglitchers.github.io/spider-event';
const API_ENDPOINT = 'https://your-vercel-project.vercel.app/api/discord-callback'; // החלף בURL של Vercel

export default async function handler(req, res) {
  // Enable CORS
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  const { code } = req.query;

  if (!code) {
    return res.status(400).json({ error: 'Missing authorization code' });
  }

  try {
    // Exchange code for access token
    const tokenResponse = await fetch('https://discord.com/api/v10/oauth2/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: querystring.stringify({
        client_id: DISCORD_CLIENT_ID,
        client_secret: DISCORD_CLIENT_SECRET,
        code: code,
        grant_type: 'authorization_code',
        redirect_uri: API_ENDPOINT.replace('/api/discord-callback', ''),
        scope: 'identify',
      }),
    });

    if (!tokenResponse.ok) {
      const errorData = await tokenResponse.json();
      console.error('Token error:', errorData);
      return res.status(tokenResponse.status).json({ error: errorData });
    }

    const tokenData = await tokenResponse.json();

    // Get user info
    const userResponse = await fetch('https://discord.com/api/v10/users/@me', {
      headers: {
        Authorization: `Bearer ${tokenData.access_token}`,
      },
    });

    if (!userResponse.ok) {
      return res.status(userResponse.status).json({ error: 'Failed to fetch user' });
    }

    const userData = await userResponse.json();

    // Return user data
    return res.status(200).json({
      success: true,
      user: {
        id: userData.id,
        username: userData.username,
        discriminator: userData.discriminator,
        avatar: userData.avatar,
      },
      token: tokenData.access_token,
    });
  } catch (error) {
    console.error('OAuth error:', error);
    return res.status(500).json({ error: error.message });
  }
}
